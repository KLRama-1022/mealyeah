<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MealYeah - PG Meal Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Add Google Fonts for a modern look -->
  <link href="https://fonts.googleapis.com/css?family=Quicksand:400,700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
      color: #222;
      max-width: 520px;
      margin: auto;
      padding: 1rem;
    }
    .container {
      padding: 20px 10px;
      max-width: 500px;
      margin: auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.07);
    }
    .hidden {
      display: none;
    }
    h2, h4 {
      text-align: center;
      font-weight: 700;
      font-size: 2rem;
      color: #2e7d32;
      margin-bottom: 0.5em;
    }
    h4 {
      font-size: 1.2rem;
      color: #333;
    }
    label {
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
      color: #444;
    }
    input, select {
      width: 100%;
      padding: 12px 10px;
      margin: 8px 0 18px 0;
      border: 1px solid #cfd8dc;
      border-radius: 8px;
      font-size: 1em;
      background: #f7fafc;
      transition: border 0.2s;
      box-sizing: border-box;
    }
    input:focus, select:focus {
      border-color: #4CAF50;
      outline: none;
      background: #fff;
    }
    button {
      width: 100%;
      padding: 12px;
      font-family: 'Quicksand', sans-serif;
      margin: 12px 0;
      border: none;
      border-radius: 8px;
      background: linear-gradient(90deg, #4CAF50 60%, #388e3c 100%);
      color: white;
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      box-shadow: 0 2px 8px rgba(76,175,80,0.07);
    }
    button:hover {
      background: linear-gradient(90deg, #388e3c 60%, #4CAF50 100%);
      transform: translateY(-2px) scale(1.02);
    }
    button:active {
      transform: scale(0.98);
    }
    button.back-button {
      position: absolute;
      top: 18px;
      left: 18px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #388e3c;
      color: white;
      font-size: 22px;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
      min-width: 0;
      padding: 0;
      z-index: 10;
    }
    button.back-button:hover {
      background: #2e7d32;
    }
    .menu-box, .summary-box {
      margin: 18px 0;
      padding: 16px;
      background: #f8fff6;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(76,175,80,0.04);
      border: 1px solid #e0e0e0;
    }
    .menu-box {
      background: #f9fbe7;
    }
    .response-counts {
      margin-top: 10px;
      font-size: 1.05em;
    }
    .thankyou {
      font-weight: bold;
      color: #388e3c;
      margin-top: 20px;
      padding: 12px;
      background-color: #e8f5e9;
      border-radius: 10px;
      text-align: center;
      display: none;
    }
    /* Responsive tweaks */
    @media (max-width: 600px) {
      .container {
        padding: 10px 2vw;
        border-radius: 0;
        box-shadow: none;
      }
      button.back-button {
        top: 10px;
        left: 10px;
        width: 36px;
        height: 36px;
        font-size: 18px;
      }
      h2 {
        font-size: 1.3rem;
      }
    }
    /* Style datalist dropdown arrow for consistency */
    input[list]::-webkit-calendar-picker-indicator {
      opacity: 0.6;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- Initial role selection -->
    <div id="roleSelect">
      <h2>Welcome to MealYeah</h2>
      <button onclick="selectRole('resident')">I am a Resident</button>
      <button onclick="selectRole('admin')">I am Admin</button>
    </div>

    <!-- Resident UI -->
    <!-- Resident UI -->
    <div id="residentUI" class="hidden">
      <h2>Resident Check-in</h2>

      <div id="residentStep1">
        <label>Name:</label><input type="text" id="resName" required />
        <label>Room No:</label><input type="text" id="resRoom" required />
        <label>Phone:</label><input type="text" id="resMobile" />
        <label>PG Name:</label><input type="text" id="resPG"/>
        <button onclick="continueResident()">Save & Continue</button>
      </div>


      <div id="residentStep2" class="hidden">
        <!-- Back Button at the top of the page -->
          <button class="back-button" onclick="goBackToRoleSelect()">‚¨Ö</button>
          <div class="menu-box">
          <p id="greetingText" style="font-weight: bold; color: #4CAF50;">Hello!</p>
          <p><strong>Tomorrow's Menu:</strong></p>
          <p>üç≥ Breakfast: <span id="menuBreakfast">--</span></p>
          <p>üçõ Lunch: <span id="menuLunch">--</span></p>
          <p>üçΩÔ∏è Dinner: <span id="menuDinner">--</span></p>
        </div>
        
        <h2><label>Will you eat tomorrow?</label></h2>
      <div>
        <label>Breakfast:</label>
        <select id="breakfastSelect">
          <option>Yes</option><option>No</option><option>Maybe</option>
        </select>
        <label>Lunch:</label>
        <select id="lunchSelect">
          <option>Yes</option><option>No</option><option>Maybe</option>
        </select>
        <label>Dinner:</label>
        <select id="dinnerSelect">
          <option>Yes</option><option>No</option><option>Maybe</option>
        </select>
        <button onclick="submitResponse()">Submit Response</button>
      </div></div>
      <div id="thankYouMessage" class="hidden" style="text-align:left; 
      background-color: #e8f5e9; color: green;
      text-align: center;">
        Your response has been recorded. Thank you!
      </div>
      
    </div>
  
    <!-- Admin UI -->
    <div id="adminUI" class="hidden">
      <button class="back-button" onclick="goBackToRoleSelect()">‚¨Ö</button>
      <h2>Welcome back, Admin!</h2>
      <h4>Update Tomorrow‚Äôs Menu</h4>
      <label for="adminBreakfast">Breakfast</label>
      <select id="adminBreakfast">
        <option value="">Select Breakfast</option>
        <option value="Puri">Puri</option>
        <option value="Idli">Idli</option>
        <option value="Uthappam">Uthappam</option>
        <option value="Chapati">Chapati</option>
        <option value="Dosa">Dosa</option>
        <option value="Noodles">Noodles</option>
        <option value="Khichidi">Khichidi</option>
      </select>
      <label for="adminLunch">Lunch</label>
      <select id="adminLunch">
        <option value="">Select Lunch</option>
        <option value="Rice and Dal">Rice and Dal</option>
        <option value="Rice + Paneer + Chicken">Rice + Paneer + Chicken</option>
        <option value="Veg Pulav">Veg Pulav</option>
      </select>
      <label for="adminDinner">Dinner Curries</label>
      <select id="adminDinner">
        <option value="">Select Dinner Curry</option>
        <option value="Cabbage">Cabbage</option>
        <option value="Brinjal">Brinjal</option>
        <option value="Bottlegourd">Bottlegourd</option>
        <option value="Chole">Chole</option>
        <option value="Chana">Chana</option>
        <option value="Potato">Potato</option>
        <option value="Egg">Egg</option>
      </select>
      <button onclick="updateMenu()">Update Menu</button>
      <p id="menuUpdateMessage" style="text-align:center; color: #4CAF50; font-weight: bold; display:none;">
        ‚úÖ New menu updated!
      </p>
      <div class="summary-box">
        <h4>Responses Summary</h4>
        <div class="response-counts" id="responseSummary">Loading...</div>
      </div>
    </div>
  </div>


  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDksSfoYP4Nmt1Gb0ad50kA29My1SJhSOw",
      authDomain: "mealyeah-1c61b.firebaseapp.com",
      projectId: "mealyeah-1c61b",
      storageBucket: "mealyeah-1c61b.appspot.com",
      messagingSenderId: "929819945813",
      appId: "1:929819945813:web:acdb450832773816911ddc"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ADMIN_KEY = "admin1234";
    const today = new Date();
    const tomorrowKey = new Date(today);
    tomorrowKey.setDate(today.getDate() + 1);
    const dateKey = tomorrowKey.toISOString().split('T')[0];

    function selectRole(role) {
  document.getElementById('roleSelect').classList.add('hidden');
 


  if (role === 'resident') {
    document.getElementById('residentUI').classList.remove('hidden');
  } else {
    const savedAdminKey = localStorage.getItem("adminAccessKey");

    if (savedAdminKey === ADMIN_KEY) {
      // Auto-login
      document.getElementById('adminUI').classList.remove('hidden');
      loadMenu();
      loadResponsesSummary();
    } else {
      const inputKey = prompt("Enter Admin Access Key:");
      if (inputKey === ADMIN_KEY) {
        localStorage.setItem("adminAccessKey", inputKey);  // Save key
        document.getElementById('adminUI').classList.remove('hidden');
        document.getElementById("adminGreeting").innerText = "Welcome back, Admin!";
        loadMenu();
        loadResponsesSummary();
      } else {
        alert("Access Denied. Returning to home.");
        document.getElementById('roleSelect').classList.remove('hidden');
        
      }
    }
  }
}


function continueResident() {
  const name = document.getElementById("resName").value.trim();
  const room = document.getElementById("resRoom").value.trim();
  const mobile = document.getElementById("resMobile").value.trim();
  const pgname = document.getElementById("resPG").value.trim();

  // Validate name (should be a string and not empty)
  if (!name || !isNaN(name)) {
    alert("Please enter a valid name (letters only).");
    return;
  }

  // Validate room (should be a number)
  if (!room || isNaN(room)) {
    alert("Please enter a valid room number (numbers only).");
    return;
  }

  // Validate mobile (if provided, should be a number)
  if (mobile && isNaN(mobile)) {
    alert("Please enter a valid phone number (numbers only).");
    return;
  }

  // Validate PG name (if provided, should be a string)
  if (pgname && !isNaN(pgname)) {
    alert("Please enter a valid PG name (letters only).");
    return;
  }

  // Save to localStorage
  localStorage.setItem("residentInfo", JSON.stringify({ name, room, mobile, pgname }));
  document.getElementById("greetingText").innerText = `Hello, ${name}!`;

  document.getElementById("residentStep1").classList.add("hidden");
  document.getElementById("residentStep2").classList.remove("hidden");
  loadMenu();
}


    function loadMenu() {
      db.collection("menus").doc(dateKey).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById("menuBreakfast").innerText = data.breakfast || "--";
          document.getElementById("menuLunch").innerText = data.lunch || "--";
          document.getElementById("menuDinner").innerText = data.dinner || "--";

          if (document.getElementById("adminBreakfast")) {
            document.getElementById("adminBreakfast").value = data.breakfast || "";
            document.getElementById("adminLunch").value = data.lunch || "";
            document.getElementById("adminDinner").value = data.dinner || "";
          }
        }
      });
    }

      // ...existing code...
      function goBackToRoleSelect() {
        // Hide all main sections
        document.getElementById("residentUI").classList.add("hidden");
        document.getElementById("adminUI").classList.add("hidden");
        // Show only the role selection
        document.getElementById("roleSelect").classList.remove("hidden");
      }
// ...existing code...
    function submitResponse() {
      const name = document.getElementById("resName").value.trim();
      const room = document.getElementById("resRoom").value.trim();
      const pgname = document.getElementById("resPG").value.trim();
      const mobile = document.getElementById("resMobile").value.trim();
      if (!name || !room) {
        alert("Name and Room number are required.");
        return;
      }

      const responseData = {
        breakfast: document.getElementById("breakfastSelect").value,
        lunch: document.getElementById("lunchSelect").value,
        dinner: document.getElementById("dinnerSelect").value,
        room,
        pgname,
        mobile
      };

      db.collection("responses").doc(dateKey).set({
        [name]: responseData
      }, { merge: true }).then(() => {
        document.getElementById("thankYouMessage").classList.remove("hidden");
      });
    }
    window.onload = () => {
  const savedInfo = JSON.parse(localStorage.getItem("residentInfo"));
  document.getElementById("greetingText").innerText = `Hello, ${savedInfo.name}!`;

  if (savedInfo && savedInfo.name && savedInfo.room) {
    // Populate hidden inputs in case needed later
    document.getElementById("resName").value = savedInfo.name;
    document.getElementById("resRoom").value = savedInfo.room;
    document.getElementById("resMobile").value = savedInfo.mobile || "";
    document.getElementById("resPG").value = savedInfo.pgname || "";

    document.getElementById("roleSelect").classList.add("hidden");
    document.getElementById("residentUI").classList.remove("hidden");
    document.getElementById("residentStep1").classList.add("hidden");
    document.getElementById("residentStep2").classList.remove("hidden");
    loadMenu();
  }
};

function updateMenu() {
  const breakfast = document.getElementById("adminBreakfast").value.trim();
  const lunch = document.getElementById("adminLunch").value.trim();
  const dinner = document.getElementById("adminDinner").value.trim();

  db.collection("menus").doc(dateKey).set({
    breakfast, lunch, dinner
  }).then(() => {
    // Clear old responses silently
    db.collection("responses").doc(dateKey).delete().catch((error) => {
      console.error("Error deleting responses: ", error);
    });

    // Show the "New Menu Updated" message in the UI
    const updateMessage = document.getElementById("menuUpdateMessage");
    updateMessage.style.display = "block"; // Show the message

    // Hide it after 3 seconds
    setTimeout(() => {
      updateMessage.style.display = "none"; // Hide the message
    }, 3000);

    loadMenu();
    loadResponsesSummary(); // Refresh the responses summary (or reset)
  });
}

    function loadResponsesSummary() {
      db.collection("responses").doc(dateKey).onSnapshot(doc => {
        if (!doc.exists) {
          document.getElementById("responseSummary").innerText = "No responses yet.";
          return;
        }

        const data = doc.data();
        let summary = {
          breakfast: { Yes: 0, No: 0, Maybe: 0 },
          lunch:    { Yes: 0, No: 0, Maybe: 0 },
          dinner:   { Yes: 0, No: 0, Maybe: 0 },
        };

        Object.values(data).forEach(entry => {
          ["breakfast", "lunch", "dinner"].forEach(meal => {
            if (entry[meal]) {
              summary[meal][entry[meal]]++;
            }
          });
        });
        

        document.getElementById("responseSummary").innerHTML = `
          üç≥ <b>Breakfast:</b> Yes: ${summary.breakfast.Yes}, No: ${summary.breakfast.No}, Maybe: ${summary.breakfast.Maybe}<br>
          üçõ <b>Lunch:</b> Yes: ${summary.lunch.Yes}, No: ${summary.lunch.No}, Maybe: ${summary.lunch.Maybe}<br>
          üçΩÔ∏è <b>Dinner:</b> Yes: ${summary.dinner.Yes}, No: ${summary.dinner.No}, Maybe: ${summary.dinner.Maybe}
        `;
      });
    }

  </script>
</body>
</html>
